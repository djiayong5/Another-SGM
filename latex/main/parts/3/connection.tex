\section{Пример использования}
Рассмотрим простой пример. Пусть требуется построить сетевое соединение, поведение которого заданно
диаграммой состояний, изображенной на рис.~\ref{connection}.

\drawfigure{pic/connection.1}{Диаграмма состояний сетевого соединения}{connection}

Первоначально опишем внешний интерфейс соединения --- интерфейс \stClassName{Connection} 
(рис~\ref{connectionCD}).

\vbox{
\startprog
public interface Connection {

    void connect();

    void disconnect();

}
\end{lstlisting}
}

\drawfigurex{}{angle=-90,width=155mm}{pic/connection.eps}{Диаграмма классов сетевого соединения}{connectionCD}

Далее реализуем абстрактный класс \stClassName{AbstractConnectionState}, являющийся предком 
всех классов, описывающих состояния соединения. Все эти классы должны реализовывать
интерфейсы \stClassName{IState<Connection>} и \stClassName{Connection}, поэтому реализуем
их в классе \stClassName{AbstractConnectionState}.

\vbox{
\startprog
abstract public class AbstractConnectionState 
                  implements IState<Connection>, Connection {
    
    protected final IStateMachine<Connection> sm;

    protected final String host;


    public AbstractConnectionState(
               IStateMachine<Connection> sm, 
               String host) {
        this.sm = sm;
        this.host = host;
    }

    public void entry() {
    }

    public void exit() {
    }

    public void connect() {
    }

    public void connect() {
    }

}
\end{lstlisting}
}

Теперь реализуем классы состояний: \stClassName{ConnectedState} и \stClassName{DisconnectedState}.

\vbox{
\startprog
@State (
        name = "disconnected"
)
public class DisconnectedState extends AbstractConnectionState {

    public DisconnectedState(
               IStateMachine<Connection> sm, 
               String host) {
        super(sm, host);
    }

    public void connect() {
        sm.changeState(ConnectedState.class);
    }

}
\end{lstlisting}
}

\vbox{
\startprog
@State (
        name = "connected"
)
public class ConnectedState extends AbstractConnectionState {

    public ConnectedState(
               IStateMachine<Connection> sm, 
               String host) {
        super(sm, host);
    }

    public void entry() {
        // Connect to Host
    }

    public void exit() {
        // Disconnect
    }

    public void disconnect() {
        sm.changeState(DisconnectedState.class);
    }

}
\end{lstlisting}
}

Реализуем класс \stClassName{ConnectionStateFactory}, используемый для построения экземпляров классов состояния
соединения. При этом применяется механизм Reflection. Заметим, в классах состояний должен быть конструктор с 
параметрами типа: \stClassName{IStateMachine} и \stClassName{String}.

\vbox{
\startprog
public class ConnectionStateFactory implements IStateFactory<Connection> {

    private IStateMachine<Connection> sm;

    private final String host;
                    
    public ConnectionStateFactory(
               String host) {
        this.host = host;
    }

    public void setStateMachine(IStateMachine<Connection> sm) {
        this.sm = sm;
    }

    public <T extends IState<Connection>>T constructState(
               Class<T> stateClass, 
               Properties properties) {
        try {
            return stateClass.getConstructor(
                       IStateMachine.class, 
                       String.class
                    ).newInstance(sm, host);
        } catch (Exception e) {
            return null;
        }
    }

}
\end{lstlisting}
}

Теперь все готово для создания объекта, реализующего диаграмму состояний, изображенную на рис.~\ref{connection}. 
Поскольку это действие не тривиально, реализуем его в специальном классе \stClassName{ConnectionFactory}.

\vbox{
\startprog
public class ConnectionFactory {

    private static final 
        StateMachineFactory<Connection> SMF = 
        StateMachineFactory.newInstance();

    public static Connection createConnection(
               String host) {
        IStateMachine<Connection> sm =
                SMF.createStateMachine(
                    Connection.class, 
                    new ConnectionStateFactory(host)
                );
        sm.changeState(Disconnected.class);
        return (Connection)sm;
    }

}
\end{lstlisting}
}




